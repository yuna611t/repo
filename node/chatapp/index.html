<html>
    <head>
        <meta charset="UTF-8" />
        <title>簡易チャット</title>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js" ></script>
    </head>
    <body>
        <input type="text" id="msg_input" style="width:200px;" />
        <button onclick="publishMessage();">語る</button>
        <div id="msg"></div>
        <script src="/socket.io/socket.io.js"></script>
        <script type="text/javascript">
            // イベントとコールバックの定義
            var socketio = io.connect('http://localhost:8080');

            socketio.on("connected", function(name) {});
            socketio.on("publish", function(data) {addMessage(data.value);});
            socketio.on("disconnect", function() {});

            // イベントに絡む関数
            function start(name) {
                socketio.emit("connected", name);
            }

            function publishMessage() {
                var textInput = $('#msg_input');
                var msg = "[" + myName + "]" + textInput.val();
                socketio.emit("publish", {value: msg});
                textInput.val('');
            }

            function addMessage(msg) {
                $($.parseHTML('<div/>'))
                  .html(new Date().toLocaleTimeString() + ' ' + msg)
                  .appendTo(msgArea);
            }

            // 開始処理
            var msgArea = $('#msg');
            var myName = Math.floor(Math.random()*100) + "さん";
            addMessage("貴方は" + myName + "として入室しました");
            start(myName);
        </script>
    </body>
</html>
