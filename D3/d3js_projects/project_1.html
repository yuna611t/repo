<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>D3.jsの勉強</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<style>
svg { width: 380px; height: 240px; border: 1px solid black; }
.mark { fill: red; stroke: none; }
.axis text {
    font-family: sans-serif;
    font-size: 11px;
}
.axis path,
.axis line {
    fill: none;
    stroke: black;
}
.grid {
    stroke: gray;
    stroke-dasharray: 4, 2;
    shape-rendering: crispEdges;
}
.tip {
    position: absolute;
    top: 0px;
    left: 0px;
    z-index: 9999;
    visibility: hidden;
    border: 1px solid black;
    background-color: yellow;
    width: 80px;
    height: 16px;
    overflow: hidden;
    text-align: center;
    font-size: 9pt;
    font-family: Tahoma, Optima, Helvetica;
    color: black;
}
</style>
    </head>
    <body>

<h1>散布図をアニメーションでplot</h1>
<svg id="myGraph"></svg>

<script type="text/javascript">
d3.csv("mydata.csv", function (error, data) {
    // SVGの幅と高さを求める
    var svgEle = document.getElementById("myGraph");
    var svgWidth = window.getComputedStyle(svgEle, null).getPropertyValue("width");
    var svgHeight = window.getComputedStyle(svgEle, null).getPropertyValue("height");
    svgWidth = parseFloat(svgWidth);   // 単位削除
    svgHeight = parseFloat(svgHeight); // 単位削除
    var offsetX = 30;
    var offsetY = 20;
    var svg = d3.select("#myGraph");    // SVG要素
    // データ読み込み設定
    var dataSet = [];
    data.forEach(function (d, i) {
        dataSet.push([d.total/100, d.bug*1, d.time*1]);
    });
    // 散布図を描画
    var circleElements = svg
        .selectAll("circle")
        .data(dataSet)
    circleElements
        .enter()
        .append("circle")
        .attr("class", "mark")
        // 初期状態
        .attr("cx", svgWidth/2 + offsetX)
        .attr("cy", svgHeight/2 - offsetY)
        .attr("r", 100)
        .attr("opacity", 0)
        .transition()
        .duration(2000)
        .ease("bounce")
        // アニメーション後
        .attr("cx", function (d, i) {
            return d[0] + offsetX;
        })
        .attr("cy", function (d, i) {
            return svgHeight - d[1] - offsetY;
        })
        .attr("r", 5)
        .attr("opacity", 1.0)

        /**
         * 目盛りを描画する
         */
        function drawScale () {
            var maxX = d3.max(dataSet, function (d, i) {
                return d[0];
            })
            var maxY = d3.max(dataSet, function (d, i) {
                return d[1];
            })
            // 縦の目盛りを表示するためにD3スケールを設定
            var yScale = d3.scale.linear()
                .domain([0, maxY])
                .range([maxY, 0])
            // 目盛りを表示
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate("+ offsetX + ", "+ (svgHeight - maxY - offsetY) +")")
                .call(
                    d3.svg.axis()
                        .scale(yScale)
                        .orient("left")
                )
            // 縦の目盛りを表示するためにD3スケールを設定
            var xScale = d3.scale.linear()
                .domain([0, maxX])
                .range([0, maxX])
            // 目盛りを表示
            d3.select("#myGraph")
                .append("g")
                .attr("class", "axis")
                .attr("transform", "translate("+ offsetX + ", "+ (svgHeight - offsetY) +")")
                .call(
                    d3.svg.axis()
                        .scale(xScale)
                        .orient("bottom")
                )
            // グリッドの表示
            var grid = svg.append("g")
            // 横方向と縦方向のグリッド間隔を自動生成
            var rangeX = d3.range(50, maxX, 50);
            var rangeY = d3.range(20, maxY, 20);
            // 縦方向のグリッドを生成
            grid.selectAll("line.y")
                .data(rangeY)
                .enter()
                .append("line")
                .attr("class", "grid")
                .attr("x1", offsetX)
                .attr("y1", function (d, i) {
                    return svgHeight - d -offsetY;
                })
                .attr("x2", maxX + offsetX)
                .attr("y2", function (d, i) {
                    return svgHeight - d - offsetY;
                })
            // 横方向のグリッドを生成
            grid.selectAll("line.x")
                .data(rangeX)
                .enter()
                .append("line")
                .attr("class", "grid")
                .attr("x1", function (d, i) {
                    return d + offsetX;
                })
                .attr("y1", svgHeight - offsetY)
                .attr("x2", function (d, i) {
                    return d + offsetX;
                })
                .attr("y2", svgHeight - offsetY - maxY)
            // ツールチップを生成
            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "tip")
            // ツールチップを表示
            circleElements
                .on("mouseover", function (d) {
                    var x = parseInt(d[0]);
                    var y = parseInt(d[1]);
                    var data = d3.select(this).datum(); //要素のデータを読み出す
                    var t = parseInt(data[2]);
                    tooltip
                        .style("left", offsetX + x + "px")
                        .style("top", svgHeight + offsetY - y + "px")
                        .style("visibility", "visible")
                        .text(t + "時間")
                })
                .on("mouseout", function () {
                    tooltip.style("visibility", "hidden")
                })
        }
        // 目盛りとグリッドを表示する
        drawScale();

})
</script>
    </body>
</html>
